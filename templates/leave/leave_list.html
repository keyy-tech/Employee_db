<!-- filepath: c:\Users\emman\OneDrive\Desktop\Employee_db\templates\dashboard\leave_list.html -->
{% extends "base_generic.html" %}

{% block content %}
    <div class="container mt-3">
        <div class="card p-4 mb-4 shadow-sm">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by employee name...">
                </div>
                <div class="col-md-4 mb-3">
                    <select id="statusSelect" class="form-select">
                        <option value="">Filter by status</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <select id="rowsPerPageSelect" class="form-select">
                        <option value="10">Show 10 rows</option>
                        <option value="20">Show 20 rows</option>
                        <option value="100">Show 100 rows</option>
                    </select>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead>
                    <tr>
                        <th>Initials</th>
                        <th>Employee</th>
                        <th>Leave Type</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Status</th>
                        <th>Action/Remarks</th>
                    </tr>
                    </thead>
                    <tbody id="leaveTableBody">
                    {% for leave in leaves %}
                        <tr>
                            <td class="text-center">
                                <div class="user-initials">
                                    {{ leave.employee.user.first_name.0 }}{{ leave.employee.user.last_name.0 }}
                                </div>
                            </td>
                            <td>{{ leave.employee }}</td>
                            <td>{{ leave.leave_type }}</td>
                            <td>{{ leave.start_date }}</td>
                            <td>{{ leave.end_date }}</td>
                            <td>{{ leave.status }}</td>
                            <td>
                                {% if leave.status == "Pending" %}
                                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                            data-bs-target="#approveModal" data-id="{{ leave.id }}">Approve
                                    </button>
                                    <button class="btn btn-danger btn-sm" data-bs-toggle="modal"
                                            data-bs-target="#rejectModal" data-id="{{ leave.id }}">Reject
                                    </button>
                                {% else %}
                                    Completed
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">No leave requests found.</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Approve Modal -->
    <div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="approveModalLabel">Approve Leave Request</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to approve this leave request?
                </div>
                <div class="modal-footer">
                    <form id="approveForm" method="post" action="">
                        {% csrf_token %}
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Approve</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Reject Modal -->
    <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectModalLabel">Reject Leave Request</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to reject this leave request?
                </div>
                <div class="modal-footer">
                    <form id="rejectForm" method="post" action="">
                        {% csrf_token %}
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Reject</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var approveModal = document.getElementById('approveModal');
            var rejectModal = document.getElementById('rejectModal');

            approveModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var leaveId = button.getAttribute('data-id');
                var form = document.getElementById('approveForm');
                form.action = '{% url "approve_leave" 0 %}'.replace('0', leaveId);
            });

            rejectModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var leaveId = button.getAttribute('data-id');
                var form = document.getElementById('rejectForm');
                form.action = '{% url "reject_leave" 0 %}'.replace('0', leaveId);
            });

            // Search and filter functionality
            var searchInput = document.getElementById('searchInput');
            var statusSelect = document.getElementById('statusSelect');
            var rowsPerPageSelect = document.getElementById('rowsPerPageSelect');
            var leaveTableBody = document.getElementById('leaveTableBody');

            searchInput.addEventListener('input', filterTable);
            statusSelect.addEventListener('change', filterTable);
            rowsPerPageSelect.addEventListener('change', filterTable);

            function filterTable() {
                var searchValue = searchInput.value.toLowerCase();
                var statusValue = statusSelect.value;
                var rowsPerPage = parseInt(rowsPerPageSelect.value);
                var rows = leaveTableBody.getElementsByTagName('tr');
                var visibleRowCount = 0;

                for (var i = 0; i < rows.length; i++) {
                    var employeeCell = rows[i].getElementsByTagName('td')[1];
                    var statusCell = rows[i].getElementsByTagName('td')[5];
                    var employeeText = employeeCell.textContent.toLowerCase();
                    var statusText = statusCell.textContent;

                    var matchesSearch = employeeText.includes(searchValue);
                    var matchesStatus = statusValue === "" || statusText === statusValue;

                    if (matchesSearch && matchesStatus) {
                        if (visibleRowCount < rowsPerPage) {
                            rows[i].style.display = "";
                            visibleRowCount++;
                        } else {
                            rows[i].style.display = "none";
                        }
                    } else {
                        rows[i].style.display = "none";
                    }
                }
            }

            // Initial filter to apply rows per page setting
            filterTable();
        });
    </script>
{% endblock %}

<style>
    .user-initials {
        width: 35px;
        height: 35px;
        background: #2c3e50;
        color: white;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 1rem;
        text-transform: uppercase;
        margin: auto;
    }
</style>